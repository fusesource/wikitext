<?xml version="1.0" encoding="UTF-8"?>
<project name="mylyn" default="all" basedir=".">
	<property file="local.properties" />
	<property file="defaults.properties" />

	<import file="scripts/buildHelper.xml" />
	<available classname="java.lang.Enum" property="java.isVersion5OrHigher"/>

	<target name="check-java" unless="java.isVersion5OrHigher">
		<fail message="Java 1.5 or higher required (${java.version} detected)"/>
	</target>
	
	<target name="init-base" depends="check-java">		
		<mkdir dir="${eclipse.base}"/>
		<mkdir dir="${build.home}"/>
		<mkdir dir="${build.results}"/>
	</target>
		
	<target name="init" depends="init-base">		
		<property file="timestamp.properties" />
		<echo message="Mylyn ${version}.${qualifier}" />
	</target>

	<target name="init-build" depends="init-base">		
		<tstamp>
			<format property="qualifier" pattern="'I'yyyyMMdd-HH00" locale="en,US" timezone="UTC"/>
		</tstamp>
		<echo message="qualifier=${qualifier}" file="timestamp.properties"/>
		
		<antcall target="forEach">
			<param name="call" value="get-build-dependencies-helper"/>
		</antcall>		
	</target>

	<target name="init-tests" depends="init">		
		<antcall target="forEach">
			<param name="call" value="get-test-dependencies-helper"/>
		</antcall>		
	</target>

	<target name="all" depends="clean,build,tests,performance-tests">
	</target>
	
	<target name="clean" depends="clean-tests">
		<antcall target="forEach">
			<param name="call" value="clean-build-helper"/>
		</antcall>
	</target>

	<target name="clean-tests">
		<antcall target="forEach">
			<param name="call" value="clean-tests-helper"/>
		</antcall>
	</target>

	<target name="report" depends="init">
		<antcall target="forEach">
			<param name="call" value="report-helper"/>
		</antcall>
	</target>

	<target name="publish" depends="init">
		<antcall target="forEach">
			<param name="call" value="publish-helper"/>
			<param name="skip3.3" value="true"/>
			<param name="skip3.5" value="true"/>
		</antcall>
	</target>

	<target name="tests" depends="init-tests">
		<antcall target="forEach">
			<param name="call" value="test-helper"/>
			<param name="test.target" value="run"/>
		</antcall>
	</target>

	<target name="package" depends="init">
		<antcall target="forEach">
			<param name="call" value="package-helper"/>
		</antcall>
	</target>

	<target name="performance-tests">
		<antcall target="forEach">
			<param name="call" value="test-helper"/>
			<param name="test.target" value="performance"/>
		</antcall>
	</target>

	<target name="update-versions">
		<replace dir="..">
			<replacefilter 
			    token="3.1.0.qualifier"
				value="${version}.qualifier"/>
			<replacefilter 
			    token="3.1.0.mylynQualifier"
				value="${version}.mylynQualifier"/>
			<include name="org.eclipse.mylyn*/**/MANIFEST.MF"/>
			<include name="org.eclipse.mylyn*/**/feature.xml"/>
		</replace>
	</target>

	<target name="build" depends="init-build,init">
		<antcall target="forEach">
			<param name="call" value="build-helper"/>
		</antcall>
	</target>

	<target name="pack" depends="init">
		<antcall target="forEach">
			<param name="call" value="pack-sites"/>
		</antcall>
	</target>

	<target name="pack-sites" depends="init">
		<antcall target="pack-helper">
			<param name="dir" value="${build.home}/${eclipse.version}/standardUpdateSite"/>
		</antcall>
		<antcall target="pack-helper">
			<param name="dir" value="${build.home}/${eclipse.version}/extrasUpdateSite"/>
		</antcall>
		<antcall target="pack-helper">
			<param name="dir" value="${build.home}/${eclipse.version}/incubatorUpdateSite"/>
		</antcall>
	</target>

	<target name="generate-metadata" depends="init">
		<antcall target="forEach">
			<param name="call" value="generate-metadata-sites"/>
		</antcall>
	</target>

	<target name="generate-metadata-sites" depends="init">
		<antcall target="generate-metadata-helper">
			<param name="dir" value="${build.home}/${eclipse.version}/standardUpdateSite"/>
			<param name="name" value="Mylyn Weekly for Eclipse ${eclipse.version}"/>
		</antcall>
		<antcall target="generate-metadata-helper">
			<param name="dir" value="${build.home}/${eclipse.version}/extrasUpdateSite"/>
			<param name="name" value="Mylyn Weekly Extras"/>
		</antcall>
		<antcall target="generate-metadata-helper">
			<param name="dir" value="${build.home}/${eclipse.version}/incubatorUpdateSite"/>
			<param name="name" value="Mylyn Weekly Incubator"/>
		</antcall>
	</target>

	<target name="dist" depends="init,pack,generate-metadata">
		<property name="dist.dir" value="${dist.home}/update-archive/${version}/${qualifier}" />
		<copy todir="${dist.dir}/e3.3">
			<fileset dir="${build.home}/3.3/standardUpdateSite"/>
		</copy>
		<copy todir="${dist.dir}/e3.4">
			<fileset dir="${build.home}/3.4/standardUpdateSite"/>
		</copy>
		<copy todir="${dist.dir}/extras">
			<fileset dir="${build.home}/3.4/extrasUpdateSite"/>
		</copy>
		<copy todir="${dist.dir}/incubator">
			<fileset dir="${build.home}/3.4/incubatorUpdateSite"/>
		</copy>
		<copy tofile="${dist.dir}/mylyn-${version}.${qualifier}-e3.3.zip" file="${build.home}/3.3/mylyn-${version}.${qualifier}-e33-standard.zip" />
		<copy tofile="${dist.dir}/mylyn-${version}.${qualifier}-e3.4.zip" file="${build.home}/3.4/mylyn-${version}.${qualifier}-e3x-standard.zip" />
		<copy tofile="${dist.dir}/mylyn-${version}.${qualifier}-extras.zip" file="${build.home}/3.4/mylyn-${version}.${qualifier}-e3x-extras.zip" />
		<copy tofile="${dist.dir}/mylyn-${version}.${qualifier}-incubator.zip" file="${build.home}/3.4/mylyn-${version}.${qualifier}-e3x-incubator.zip" />
		<copy tofile="${dist.dir}/mylyn-wikitext-standalone-${version}.${qualifier}_incubation.zip" file="${build.home}/3.4/mylyn-wikitext-standalone-${version}.${qualifier}_incubation.zip" />

		<antcall target="fix-permissions">
			<param name="dir" value="${dist.dir}"/>
		</antcall>
	</target>

	<target name="weekly" depends="clean,build,dist">
		<antcall target="promote">
			<param name="target" value="weekly"/>
		</antcall>
	</target>

	<target name="dev" depends="clean,build,dist">
		<antcall target="promote">
			<param name="target" value="dev"/>
		</antcall>
	</target>

	<target name="promote" depends="init">
		<property name="dist.dir" value="${dist.home}/update-archive/${version}/${qualifier}" />
		<property name="target.dir" value="${dist.home}/update/${target}" />
		<delete dir="${target.dir}.old" />
		<move file="${target.dir}" todir="${target.dir}.old" failonerror="false"/>
		<copy todir="${target.dir}">
			<fileset dir="${dist.dir}"/>
		</copy>

		<!-- not supported on build.eclipse.org
		<move todir="${target.dir}">
			<fileset dir="${target.dir}">
				<include name="*.zip"/>
			</fileset>
			<mapper type="regexp" from="(.*)${version}.${qualifier}(.*)" to="\1latest\2"/>
		</move>
		-->
		<move tofile="${target.dir}/mylyn-latest-e3.3.zip" file="${target.dir}/mylyn-${version}.${qualifier}-e3.3.zip" />
		<move tofile="${target.dir}/mylyn-latest-e3.4.zip" file="${target.dir}/mylyn-${version}.${qualifier}-e3.4.zip" />
		<move tofile="${target.dir}/mylyn-latest-extras.zip" file="${target.dir}/mylyn-${version}.${qualifier}-extras.zip" />
		<move tofile="${target.dir}/mylyn-latest-incubator.zip" file="${target.dir}/mylyn-${version}.${qualifier}-incubator.zip" />
		<move tofile="${target.dir}/mylyn-wikitext-standalone-latest_incubation.zip" file="${target.dir}/mylyn-wikitext-standalone-${version}.${qualifier}_incubation.zip" />
		
		<antcall target="fix-permissions">
			<param name="dir" value="${target.dir}"/>
		</antcall>
	</target>

	
</project>