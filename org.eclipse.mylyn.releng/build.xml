<?xml version="1.0" encoding="UTF-8"?>
<project name="mylyn" default="" basedir=".">
	<property file="defaults.properties" />
	<property file="timestamp.properties" />

	<property name="version" value="3.1.0" />

	<import file="scripts/buildHelper.xml" />
	
	<target name="init">		
		<mkdir dir="${eclipse.base}"/>
		<mkdir dir="${build.home}"/>
		<mkdir dir="${build.results}"/>
	</target>

	<target name="init-build">		
		<tstamp>
			<format property="qualifier" pattern="'I'yyyyMMdd-HH00" locale="en,US" timezone="UTC"/>
		</tstamp>
		<echo message="qualifier=${qualifier}" file="timestamp.properties"/>
		<echo message="Building Mylyn ${version}.${qualifier}" />
		<antcall target="forEach">
			<param name="call" value="get-build-dependencies-helper"/>
		</antcall>		
	</target>

	<target name="init-tests">		
		<antcall target="forEach">
			<param name="call" value="get-test-dependencies-helper"/>
		</antcall>		
	</target>

	<!--
	<target name="all" depends="clean-tests">
		<exec executable="./build-3.4.sh" />
		<exec executable="./run-tests-3.4.sh">
			<arg value="run" />
		</exec>
		<antcall target="report" />
		<exec executable="./run-tests-3.4.sh">
			<arg value="performance" />
		</exec>
		<antcall target="report" />

		<antcall target="publish" />

		<exec executable="./build-3.3.sh" />
		<exec executable="./run-tests-3.3.sh">
			<arg value="run" />
		</exec>
		<antcall target="report" />
		<exec executable="./run-tests-3.3.sh">
			<arg value="performance" />
		</exec>
		<antcall target="report" />
	</target>
	-->
	
	<target name="all" depends="init,clean,build,test,run-performance-tests">
	</target>
	
	<target name="clean" depends="clean-tests">
		<antcall target="forEach">
			<param name="call" value="clean-build-helper"/>
		</antcall>
	</target>

	<target name="clean-tests">
		<antcall target="forEach">
			<param name="call" value="clean-tests-helper"/>
		</antcall>
	</target>

	<target name="report">
		<antcall target="forEach">
			<param name="call" value="report-helper"/>
		</antcall>
	</target>

	<target name="publish">
		<antcall target="publish-helper">
			<param name="eclipse.version" value="3.4"/>
		</antcall>
	</target>

	<target name="test">
		<!--
		<antcall target="forEach">
			<param name="call" value="run-tests-helper"/>
		</antcall>
		-->
		<antcall target="test-helper">
			<param name="eclipse.version" value="3.4"/>
		</antcall>
	</target>

	<target name="run-performance-tests">
		<antcall target="forEach">
			<param name="call" value="run-performance-tests-helper"/>
		</antcall>
	</target>

	<target name="update-versions">
		<replace dir="..">
			<replacefilter 
			    token="3.1.0.qualifier"
				value="${version}.qualifier"/>
			<replacefilter 
			    token="3.1.0.mylynQualifier"
				value="${version}.mylynQualifier"/>
			<include name="org.eclipse.mylyn*/**/MANIFEST.MF"/>
			<include name="org.eclipse.mylyn*/**/feature.xml"/>
		</replace>
	</target>

	<target name="build" depends="init,init-build">
		<antcall target="forEach">
			<param name="call" value="build-helper"/>
		</antcall>
	</target>

	<target name="dist">
		<property name="dist.dir" value="${dist.home}/update-archive/${version}/${qualifier}" />
		<copy todir="${dist.dir}/e3.3">
			<fileset dir="${build.home}/3.3/standardUpdateSite"/>
		</copy>
		<copy todir="${dist.dir}/e3.4">
			<fileset dir="${build.home}/3.4/standardUpdateSite"/>
		</copy>
		<copy todir="${dist.dir}/extras">
			<fileset dir="${build.home}/3.4/extrasUpdateSite"/>
		</copy>
		<copy todir="${dist.dir}/incubator">
			<fileset dir="${build.home}/3.4/incubatorUpdateSite"/>
		</copy>
		<copy tofile="${dist.dir}/mylyn-${version}.${qualifier}-e3.3.zip" file="${build.home}/3.3/mylyn-${version}.${qualifier}-e33-standard.zip" />
		<copy tofile="${dist.dir}/mylyn-${version}.${qualifier}-e3.4.zip" file="${build.home}/3.4/mylyn-${version}.${qualifier}-e3x-standard.zip" />
		<copy tofile="${dist.dir}/mylyn-${version}.${qualifier}-extras.zip" file="${build.home}/3.4/mylyn-${version}.${qualifier}-e3x-extras.zip" />
		<copy tofile="${dist.dir}/mylyn-${version}.${qualifier}-incubator.zip" file="${build.home}/3.4/mylyn-${version}.${qualifier}-e3x-incubator.zip" />

		<chmod perm="g+w">
			<fileset dir="${dist.dir}" />
		</chmod>
		<chgrp group="${dist.group}">
			<fileset dir="${dist.dir}" />
		</chgrp>
	</target>

	<target name="weekly">
		<antcall name="promote">
			<param name="target" value="weekly"/>
		</antcall>
	</target>
	
	<target name="promote">
		<property name="dist.dir" value="${dist.home}/update-archive/${version}/${qualifier}" />
		<property name="target.dir" value="${dist.home}/update/${target}" />
		<delete dir="${target.dir}.old" />
		<move file="${target.dir}" todir="${target.dir}.old"/>
		<copy todir="${target.dir}">
			<fileset dir="${dist.dir}"/>
		</copy>

		<chmod perm="g+w">
			<fileset dir="${target.dir}"/>
		</chmod>
		<chgrp group="${dist.group}">
			<fileset dir="${target.dir}"/>
		</chgrp>
	</target>

	
</project>